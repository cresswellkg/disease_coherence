---
title: "Connectivity Comparison Filtered"
author: "Kellen Cresswell"
date: "December 5, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.height = 6, fig.width = 9, digits = 4)
```

```{r}
source("./functions/perm_slopes.R")
source("./functions/GeneSample.R")
source("./functions/genes2interactions.R")
source("./functions/disease2frame.R")
require(KEGGREST)
require(KEGG.db)
require(readr)
require(dplyr)
require(biomaRt)
require(ggplot2)
require(broom)
require(stringr)
require(dplyr)
require(tidyr)
```

```{r}
#Repeating for string

data_dir = "./data/"

string = read_table2(paste0(data_dir,"9606.protein.links.v11.0.txt.gz"))

string = string %>% mutate(protein1 = gsub("9606.", "", protein1), 
                             protein2 = gsub("9606.", "", protein2))

#Read in ensemble protein ID

ensembl = useEnsembl(biomart="ensembl", dataset="hsapiens_gene_ensembl", mirror = "www")

genes = biomaRt::getBM(attributes=c('ensembl_peptide_id','hgnc_symbol'), mart = ensembl)


#Join gene names with string

string = left_join(string, genes, by = c("protein1" = "ensembl_peptide_id", "protein2" = "ensembl_peptide_id"))


string = left_join(string, genes, by = c("protein2" = "ensembl_peptide_id"))

string = string %>% dplyr::rename(hgnc_symbol_a = hgnc_symbol.x, hgnc_symbol_b = hgnc_symbol.y)

string = string %>% filter(combined_score>=500)

```

```{r}
#Diseases

disease_length = 1:length(disease_selected)

#Loop through diseases and pull out internal and external edges

disease_frames_string = lapply(disease_length, function(x) {

  #Run function to find internal and external connectivity 
  diseases = diseases2frame(disease_selected[x], links = string)
  
  #Record ppi missing
  
  per_no_ppi = 1- (nrow(diseases)/nrow(read.table(disease_selected[x])))
  return(list(diseases = diseases, lengths = per_no_ppi))
  })

# disease_mod_string_filt = lapply(disease_length, function(x) {
# 
#   #Run function to find internal and external connectivity 
#   mod = diseases2mod(disease_selected[x], links = string)
#   
# })
# 
# saveRDS(disease_mod_string_filt, "Modularity_String_Filt.rds")

#Pull out network information for overall data frame

disease_protein_string = lapply(disease_frames_string, function(x) x$diseases)

#Convert to data frame

disease_overall_string = bind_rows(disease_protein_string)

disease_overall_string = left_join(disease_overall_string, disease_select %>% dplyr::select(Disease, Category), "Disease")

#disease_overall_string = #readRDS("disease_overall_string.rds")

saveRDS(disease_overall_string, "string_filt_edges_new.rds")
```
