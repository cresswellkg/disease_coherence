---
title: "New_Data_Coherence"
author: "Kellen Cresswell"
date: "July 1, 2019"
output: pdf_document
---

```{r}
library(msigdbr) # install.packages("msigdbr")
library(dplyr)   # install.packages("dplyr")
library(readr)   # install.packages("readr")
source("./functions/GeneSample.R")
library(biomaRt) # BiocManager::install("biomaRt")
```
 
```{r}
#Read in edges generated from Connectivity_Comparison_*.Rmd
disease_overall_string      <- readRDS("string_edges_new.rds")
disease_overall_string_filt <- readRDS("string_filt_edges_new.rds")
disease_overall_biogrid     <- readRDS("biogrid_edges_new.rds")

#Calculate slopes for all diseases under each category
dis_slopes_string_count = disease_overall_string %>% filter(Internal != 0) %>% filter(Category != "Random") %>% filter(Category != "KEGG") %>%
    group_by(Disease, Category) %>% mutate(Count = n()) %>% group_by(Disease, Category, Count) %>%
    do({
      mod = lm(sqrt(External) ~ sqrt(Internal)-1, data = .)
      data.frame(Slope= coef(mod)[1])
    }) %>% arrange(Slope) %>% filter(Count>4)

dis_slopes_string_filt_count = disease_overall_string_filt %>% filter(Internal != 0) %>% filter(Category != "Random") %>% filter(Category != "KEGG") %>%
    group_by(Disease, Category) %>% mutate(Count = n()) %>% group_by(Disease, Category, Count) %>%
    do({
      mod = lm(sqrt(External) ~ sqrt(Internal)-1, data = .)
      data.frame(Slope= coef(mod)[1])
    }) %>% arrange(Slope) %>% filter(Count>4)

dis_slopes_biogrid_count = disease_overall_biogrid %>% filter(Internal != 0) %>% filter(Category != "Random") %>% filter(Category != "KEGG") %>%
    group_by(Disease, Category) %>% mutate(Count = n()) %>% group_by(Disease, Category, Count) %>%
    do({
      mod = lm(sqrt(External) ~ sqrt(Internal)-1, data = .)
      data.frame(Slope= coef(mod)[1])
    }) %>% arrange(Slope) %>% filter(Count>4)

```

```{r}
#Read in results generated above

#KEGG

coherence_string_filt = readRDS("./data/Coherence_Results/coherence_string_filt.rds") %>% dplyr::select(Disease, Coherence)
coherence_string = readRDS("./data/Coherence_Results/coherence_string.rds") %>% dplyr::select(Disease, Coherence)
coherence_biogrid = readRDS("./data/Coherence_Results/coherence_biogrid.rds") %>% dplyr::select(Disease, Coherence)

#Reactome

coherence_string_filt_react = readRDS("./data/Coherence_Results/coherence_string_filt_react.rds") %>% dplyr::select(Disease, Coherence)
coherence_string_react = readRDS("./data/Coherence_Results/coherence_string_react.rds") %>% dplyr::select(Disease, Coherence)
coherence_biogrid_react = readRDS("./data/Coherence_Results/coherence_biogrid_react.rds") %>% dplyr::select(Disease, Coherence)

#CC

coherence_string_filt_cc = readRDS("./data/Coherence_Results/coherence_string_filt_CC.rds") %>% dplyr::select(Disease, Coherence)
coherence_string_cc = readRDS("./data/Coherence_Results/coherence_string_CC.rds") %>% dplyr::select(Disease, Coherence)
coherence_biogrid_cc = readRDS("./data/Coherence_Results/coherence_biogrid_CC.rds") %>% dplyr::select(Disease, Coherence)

#Full join KEGG coherence results together based on disease
coherence_full = full_join(coherence_biogrid, coherence_string, by = "Disease")

coherence_full = full_join(coherence_full, coherence_string_filt, by = "Disease")

#Give columns proper name

colnames(coherence_full) = c("Disease", "Biogrid_Coherence", "String_Coherence", "String_Filt_Coherence")

#Save coherence full in this state for later manipulation
coherence_disease = coherence_full


```

```{r}
#Finish all disease plot (From save coherence disease frame)

#Joining REACTOME

coherence_disease = left_join(coherence_disease, coherence_biogrid_react, by= c("Disease"= "Disease"))

coherence_disease = left_join(coherence_disease, coherence_string_react, by= c("Disease"= "Disease"))

coherence_disease = left_join(coherence_disease, coherence_string_filt_react, by= c("Disease"= "Disease"))

#Joining CC

coherence_disease = left_join(coherence_disease, coherence_biogrid_cc, by= c("Disease"= "Disease"))

coherence_disease = left_join(coherence_disease, coherence_string_cc, by= c("Disease"= "Disease"))

coherence_disease = left_join(coherence_disease, coherence_string_filt_cc, by= c("Disease"= "Disease"))

coherence_disease = coherence_disease  %>% dplyr::rename(`Biogrid Coherence Reactome` = Coherence.x, `String Coherence Reactome` = Coherence.y, `String Filt Coherence Reactome` = Coherence.x.x, `Biogrid Coherence CC` = Coherence.y.y, `String Coherence CC` = Coherence.x.x.x, `String Filt Coherence CC` = Coherence.y.y.y)

#Get categories from slope frame

Cat = bind_rows(dis_slopes_string_count %>% ungroup() %>% dplyr::select(Disease, Category) %>% distinct(), dis_slopes_biogrid_count %>% ungroup() %>% dplyr::select(Disease, Category) %>% distinct())

#Join to all diseases frame

coherence_disease =left_join(coherence_disease, Cat)


#Remove underscores from column names
colnames(coherence_disease) = gsub("\\_", " ", colnames(coherence_disease))

coherence_disease = coherence_disease %>% dplyr::select(Disease, Category, `Biogrid Coherence`:`String Filt Coherence CC`) %>% dplyr::distinct()


#Adding gene counts

disease_select = read_csv("./data/supplementary_table_diseases_selected.csv") %>% dplyr::select(Disease =`Disease name`, `Number of SNPs`, `Number of genes`)

#Join gene counts

coherence_disease = left_join(coherence_disease, disease_select)

coherence_disease = coherence_disease %>% dplyr::select(Disease, Category, `Number of SNPs`, `Number of genes`, `Biogrid Coherence`:`String Filt Coherence CC`)
```

```{r}

#Adding p-values from permutation test
#Biogrid
biogrid_p = bind_rows(readRDS("./data/Permutation_Results/biogrid_p_1k.rds") %>% as.data.frame(.), readRDS("./data/Permutation_Results/biogrid_p_psych_1k.rds") %>% as.data.frame(.))

#String
string_p = bind_rows(readRDS("./data/Permutation_Results/string_p_1k.rds") %>% as.data.frame(.), readRDS("./data/Permutation_Results/string_p_psych_1k.rds") %>% as.data.frame(.), readRDS("./data/Permutation_Results/string_p_neuro_1k.rds") %>% as.data.frame(.))

#String Filtered
string_filt_p = bind_rows(readRDS("./data/Permutation_Results/string_filt_p_1k.rds") %>% as.data.frame(.), readRDS("./data/Permutation_Results/string_filt_p_psych_1k.rds") %>% as.data.frame(.), readRDS("./data/Permutation_Results/string_filt_p_neuro_1k.rds") %>% as.data.frame(.))

#Give appropriate name
colnames(biogrid_p) = c("Disease", "Biogrid P-value", "Ave")
colnames(string_p) = c("Disease", "String P-value", "Ave")
colnames(string_filt_p) = c("Disease", "String Filt P-value", "Ave") 

#Joining ignoring the average coherence column I saved

#Trait dataset 
coherence_full = left_join(coherence_full,biogrid_p %>% dplyr::select(-Ave))

coherence_full = left_join(coherence_full,string_p%>% dplyr::select(-Ave))

coherence_full = left_join(coherence_full,string_filt_p%>% dplyr::select(-Ave))

#Complete Disease dataset by adding p-values

coherence_disease = left_join(coherence_disease,biogrid_p %>% dplyr::select(-Ave), by = c("Disease" = "Disease"))

coherence_disease = left_join(coherence_disease,string_p %>% dplyr::select(-Ave), by = c("Disease" = "Disease"))

coherence_disease = left_join(coherence_disease,string_filt_p  %>% dplyr::select(-Ave), by = c("Disease" = "Disease"))

#Rounding data for table
coherence_disease = coherence_disease %>% mutate_if(is.numeric, round, digits = 2)

coherence_disease = coherence_disease %>% mutate(`Biogrid P-value` = round( as.numeric(as.character(`Biogrid P-value`)),4)) %>% mutate(`String P-value` = round( as.numeric(as.character(`String P-value`)),4)) %>% mutate(`String Filt P-value` = round( as.numeric(as.character(`String Filt P-value`)),4))

#Arranging by disease and category
coherence_disease =coherence_disease %>% arrange(`Category`, `Disease`)

#Rename KEGG pathways when necessary

coherence_disease = coherence_disease %>% dplyr::rename(`String Coherence KEGG` = `String Coherence`, `String Filt Coherence KEGG` = `String Filt Coherence`, `Biogrid Coherence KEGG` = `Biogrid Coherence`)

#Rename CC to GOCC to better reflect source
colnames(coherence_disease) = gsub("CC", "GOCC", colnames(coherence_disease))

#Writing to a tables

dir.create("../manuscript/tables")
write.csv(coherence_disease, ".././manuscript/tables/supplementary_table_S3.csv", 
          row.names = FALSE)

```
